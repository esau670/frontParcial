<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Ordenes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    .orden { border: 1px solid #ccc; padding: 10px; margin: 5px 0; }
  </style>
</head>
<body>

<h2>Registro</h2>
<input id="reg_nombre" placeholder="Nombre" />
<input id="reg_email" placeholder="Email" />
<input id="reg_telefono" placeholder="Teléfono" />
<button onclick="registrarCliente()">Registrar</button>
<p id="reg_msg"></p>

<h2>Login</h2>
<input id="login_email" placeholder="Email" />
<input id="login_telefono" placeholder="Teléfono" />
<button onclick="loginCliente()">Ingresar</button>
<p id="login_msg"></p>

<h2>Crear Orden</h2>
<input id="platillo_nombre" placeholder="Platillo" />
<input id="notes" placeholder="Notas" />
<button onclick="crearOrden()">Crear Orden</button>

<h2>Órdenes</h2>
<div id="ordenes"></div>

<script>
const API_URL = "https://practica2-mqvp.onrender.com"; 
let clienteId = null;

// Registrar cliente
async function registrarCliente() {
  const nombre = document.getElementById("reg_nombre").value;
  const email = document.getElementById("reg_email").value;
  const telefono = document.getElementById("reg_telefono").value;

  const res = await fetch(`${API_URL}/clientes/registrar`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nombre, email, telefono })
  });
  const data = await res.json();
  document.getElementById("reg_msg").innerText = data.msg || "Cliente registrado";
}

// Login cliente
async function loginCliente() {
  const email = document.getElementById("login_email").value;
  const telefono = document.getElementById("login_telefono").value;

  const res = await fetch(`${API_URL}/clientes/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, telefono })
  });
  const data = await res.json();

  if (res.ok) {
    document.getElementById("login_msg").innerText = data.msg;
    // Necesitamos obtener el cliente_id para órdenes
    // Supongamos que tu backend devuelve el cliente completo:
    clienteId = data.cliente?.id || null;
    listarOrdenes();
  } else {
    document.getElementById("login_msg").innerText = data.msg;
  }
}

// Crear orden
async function crearOrden() {
  if (!clienteId) return alert("Debes iniciar sesión primero");

  const platillo_nombre = document.getElementById("platillo_nombre").value;
  const notes = document.getElementById("notes").value;

  const res = await fetch(`${API_URL}/ordenes`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cliente_id: clienteId, platillo_nombre, notes })
  });
  const data = await res.json();
  listarOrdenes();
}

// Listar órdenes
async function listarOrdenes() {
  if (!clienteId) return;

  const res = await fetch(`${API_URL}/ordenes/${clienteId}`);
  const ordenes = await res.json();

  const container = document.getElementById("ordenes");
  container.innerHTML = "";
  ordenes.forEach(o => {
    const div = document.createElement("div");
    div.className = "orden";
    div.innerHTML = `
      <strong>${o.platillo_nombre}</strong> - ${o.notes}<br>
      Estado: ${o.estado}
      <button onclick="cambiarEstado(${o.id}, '${o.estado}')">Avanzar estado</button>
    `;
    container.appendChild(div);
  });
}

// Cambiar estado
async function cambiarEstado(id, estadoActual) {
  let nuevoEstado = estadoActual === "pending" ? "preparing" :
                    estadoActual === "preparing" ? "delivered" : null;
  if (!nuevoEstado) return;

  await fetch(`${API_URL}/ordenes/${id}/estado`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ estado: nuevoEstado })
  });
  listarOrdenes();
}
</script>
</body>
</html>
